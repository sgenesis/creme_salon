{% extends "base.html" %}

{% block title %}Pagar / Completar cita | Cr√™me Nails{% endblock %}

{% block content %}
<style>
  .panel {
    max-width: 1000px;
    margin: 32px auto;
    background: #ffffff;
    border-radius: 12px;
    padding: 22px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.06);
  }
  .top {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap: 12px;
    margin-bottom: 18px;
  }
  .user-avatar {
    width:40px; height:40px; border-radius:999px;
    background:#DEDEDE; display:inline-flex; align-items:center; justify-content:center;
    font-weight:700; color:#4D3A33;
  }
  .grid {
    display:grid;
    grid-template-columns: 1fr 380px;
    gap: 18px;
  }
  .left, .right {
    background:#fff; padding:14px; border-radius:10px; border: 1px solid #E6D7D0;
  }
  .line-item {
    display:flex; gap:8px; align-items:center; margin-bottom:8px;
  }
  select, input[type="text"], input[type="number"] {
    padding:8px; border-radius:8px; border:1px solid #ddd; width:100%;
  }
  .small { width:100px; }
  .btn {
    background:#4D3A33; color:white; padding:8px 12px; border-radius:8px; border:none; cursor:pointer;
  }
  .btn.ghost { background: transparent; color: #4D3A33; border: 1px solid #E6D7D0; }
  .items-list { max-height: 360px; overflow:auto; margin-bottom:12px; }
  .totals .row { display:flex; justify-content:space-between; font-weight:600; }
</style>
  


<div class="panel">
  <div class="top">
    <div>
      <h2 style="margin:0; color:#4D3A33;">Completar cita</h2>
      <div style="color:#777; font-size:14px;">ID cita: {{ appointment_id }}</div>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <div class="user-avatar" id="user-avatar"></div>
      <div style="text-align:right;">
        <div id="client-name" style="font-weight:700;"></div>
        <div style="font-size:12px; color:#666" id="client-id"></div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="left">
      <div style="margin-bottom:10px;">
        <strong>Detalles de la cita</strong>
        <div style="margin-top:6px; color:#555;">
          Servicio original: <span id="original-service" style="font-weight:700;"></span><br>
          Fecha: {{ appointment_date }} ¬∑ Hora: {{ appointment_time }}
        </div>
      </div>

      <hr style="border:none;border-top:1px solid #F0EAEA; margin:10px 0;" />

      <div class="add-row" style="display:flex;gap:8px;margin-bottom:10px">
        <select id="type-select">
          <option value="service">Servicio</option>
          <option value="product">Producto</option>
        </select>

        <select id="item-select">
          <option value="">‚Äî Selecciona ‚Äî</option>
        </select>

        <input id="price-input" type="number" step="0.01" placeholder="Precio" class="small" />

        <button class="btn ghost" id="add-item-btn">Agregar</button>
      </div>

      <div class="items-list" id="items-list"></div>
      <select id="payment-method" class="border p-2 rounded">
        <option value="cash">Efectivo</option>
        <option value="card">Tarjeta</option>
        <option value="transfer">Transferencia</option>
      </select>


      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn ghost" id="clear-items">Limpiar</button>
        <button class="btn" id="save-items" onclick="saveSale()">Guardar y completar</button>
      </div>
    </div>

    <div class="right">
      <strong>Resumen de cobro</strong>
      <div id="items-summary" style="min-height:120px; margin-top:10px"></div>

      <div class="totals">
        <div class="row"><div>Subtotal</div><div id="subtotal-no-iva">$0.00</div></div>
        <div class="row"><div>IVA (16%)</div><div id="iva">$0.00</div></div>
        <div class="row" style="font-size:18px"><div>Total</div><div id="total">$0.00</div></div>
      </div>
    </div>
  </div>
</div>

<script>
const APPT_ID = "{{ appointment_id }}";
const CLIENT_NAME = "{{ client_name|escapejs }}";
const CLIENT_ID = "{{ client_id }}";
const ORIGINAL_SERVICE_ID = "{{ original_service_id }}";
const ORIGINAL_SERVICE_NAME = "{{ original_service_name|escapejs }}";

let services = [], products = [], items = [];

document.getElementById('client-name').textContent = CLIENT_NAME;
document.getElementById('client-id').textContent = `ID: ${CLIENT_ID}`;
document.getElementById('original-service').textContent = ORIGINAL_SERVICE_NAME;
document.getElementById('user-avatar').textContent = CLIENT_NAME.split(' ').map(p=>p[0]).join('').slice(0,2).toUpperCase();

async function fetchData(url) {
  return fetch(url, { credentials: 'include' }).then(res => res.json());
}

async function loadData(){
  const s = await fetchData('/api/appointments/services/');
  const p = await fetchData('/api/products/');

  // ‚úÖ Normalizamos la respuesta a un array
  services = Array.isArray(s) ? s : s.results || s.services || [];
  products = Array.isArray(p) ? p : p.results || p.products || [];

  populateItems();

  // autocargar servicio original
  if (ORIGINAL_SERVICE_ID) {
    const svc = services.find(s => String(s.id) === String(ORIGINAL_SERVICE_ID));
    if (svc) addItem('service', svc.id, svc.name, svc.price, true);
  }

  console.log("Servicios API:", s);
  console.log("Productos API:", p);
}


function populateItems(){
  const type = document.getElementById('type-select').value;
  const select = document.getElementById('item-select');
  select.innerHTML = `<option value="">‚Äî Selecciona ‚Äî</option>`;
  const list = type === 'service' ? services : products;

  list.forEach(i => {
    select.innerHTML += `<option value="${i.id}" data-price="${i.price}">${i.name} - $${i.price}</option>`;
  });
}

  document.getElementById('type-select').addEventListener('change', populateItems);
  document.getElementById('item-select').addEventListener('change', e => {
  document.getElementById('price-input').value = e.target.selectedOptions[0]?.dataset.price || '';
});

document.getElementById('add-item-btn').addEventListener('click', () => {
  const select = document.getElementById('item-select');
  if (!select.value) return alert("Selecciona un √≠tem");
  addItem(
    document.getElementById('type-select').value,
    select.value,
    select.selectedOptions[0].text,
    document.getElementById('price-input').value
  );
});

function addItem(type, id, name, price, skip=false){
  items.push({ type, id, name, price: Number(price) });
  if (!skip) render();
}

function render(){
  const list = document.getElementById('items-list');
  const sum = document.getElementById('items-summary');
  list.innerHTML = sum.innerHTML = "";
  let total = 0;

  items.forEach((i, idx) => {
    total += i.price;

    list.innerHTML += `
      <div class="line-item">
        <div style="flex:1"><strong>${i.name}</strong></div>
        <div style="width:90px;text-align:right">$${i.price.toFixed(2)}</div>
        <button class="btn ghost" onclick="items.splice(${idx},1);render()">Eliminar</button>
      </div>`;

    sum.innerHTML += `<div>${i.name} ‚Äî $${i.price.toFixed(2)}</div>`;
  });

  const sub = total / 1.16;
  const iva = total - sub;

  document.getElementById('total').textContent = `$${total.toFixed(2)}`;
  document.getElementById('subtotal-no-iva').textContent = `$${sub.toFixed(2)}`;
  document.getElementById('iva').textContent = `$${iva.toFixed(2)}`;
}

document.getElementById('clear-items').onclick = () => { items=[]; render() };

document.getElementById('save-items').onclick = saveSale; 

loadData();

async function saveSale() {
  const paymentMethod = document.getElementById("payment-method").value;
  const totalNumber = parseFloat(document.getElementById("total").textContent.replace("$",""));

  const saleItems = items.map(i => ({
    product_id: i.type === "product" ? i.id : null,
    appointment: APPT_ID,
    quantity: 1,
    subtotal: i.price
  }));

  const payload = {
    appointment: APPT_ID,
    payment_method: paymentMethod,
    total: totalNumber,
    notes: "Venta desde cita",
    items: saleItems
  };

  const res = await fetch('/api/sales/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    credentials: 'include',
    body: JSON.stringify(payload)
  });

  if (res.ok) {
    const sale = await res.json();
    alert("‚úÖ Venta guardada");

    // üî• mostrar bot√≥n de ticket
    const btn = document.createElement("button");
    btn.innerText = "üßæ Descargar Ticket";
    btn.className = "btn";
    btn.onclick = () => window.open(`/api/sales/${sale.id}/ticket/`, "_blank");
    document.querySelector(".right").appendChild(btn);

  } else {
    alert("‚ùå Error al guardar venta");
    console.error(await res.text());
  }
}


function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}


</script>
{% endblock %}
