<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Venta R√°pida | Cr√™me Nails</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.cdnfonts.com/css/metropolis-2" rel="stylesheet">

<style>
  :root {
    --primary: #4D3A33;
    --bg: #FAF7F6;
    --panel: #ffffff;
    --border: #E6D7D0;
    --text: #4D3A33;
  }
  .dark {
    --bg:#1A1615;
    --panel:#241F1E;
    --border:#3A2F2C;
    --text:#E6D7D0;
  }
  body {
    background: var(--bg);
    font-family: 'Metropolis', sans-serif;
    transition: .3s;
  }
  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    padding: 20px;
    border-radius: 16px;
    color: var(--text);
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
  }
  select, input {
    padding:10px;
    border-radius:10px;
    border:1px solid var(--border);
    background:transparent;
    color:var(--text);
    outline:none;
    width: 100%;
  }
  select:focus, input:focus {
    border-color:var(--primary);
    box-shadow:0 0 0 2px rgba(77,58,51,0.12);
  }
  .btn {
    background:var(--primary);
    color:white;
    padding:10px 16px;
    border-radius:10px;
    font-weight:bold;
    transition:0.2s;
  }
  .btn:hover { opacity: .9; transform: translateY(-1px); }
  .btn-danger {
    background:#B43A3A;
  }
  .btn-danger:hover { opacity:.9; }
  .toggle-theme {
    width:30px; height:30px;
    border-radius:50%;
    border: 1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
  }
</style>
</head>


<body class="min-h-screen">

<!-- NAVBAR -->
<nav class="flex items-center justify-between px-5 py-4 border-b" style="border-color:var(--border)">
  <h2 class="text-xl font-bold" style="color:var(--primary)">Cr√™me Nails</h2>

  <div class="flex items-center gap-4">
    {% if user.is_superuser or user.role == 'admin' %}
      <a href="/api/appointments/salon-dashboard/" class="font-semibold" style="color:var(--text)">Citas</a>
      <a href="/api/appointments/admin-panel/" class="font-semibold" style="color:var(--text)">Administrador</a>
      <a href="/api/appointments/ventas-rapidas/" class="font-semibold" style="color:var(--text)">Venta</a>
    {% endif %}

    <a href="/dashboard/" style="color:var(--text)">üìä Ventas</a>
    <button onclick="logout()" class="font-semibold" style="color:var(--text)">Cerrar sesi√≥n</button>
    <div class="toggle-theme" onclick="toggleTheme()">üåì</div>
  </div>
</nav>

<!-- MAIN CONTENT -->
<main class="max-w-4xl mx-auto px-4 py-6 space-y-6">

  <h1 class="text-2xl font-bold mb-3" style="color:var(--text)">Venta R√°pida</h1>

  <!-- CLIENTE -->
  <section class="panel space-y-3">
    <h2 class="text-lg font-bold">Cliente</h2>

    <select id="clientSelect">
      <option value="">-- Selecciona un cliente --</option>
    </select>
  </section>


  <!-- AGREGAR PRODUCTO -->
  <section class="panel space-y-4">
    <h2 class="text-lg font-bold">Agregar Producto</h2>

    <div class="grid md:grid-cols-3 gap-4">
      <div>
        <label>Producto</label>
        <select id="productSelect"></select>
      </div>

      <div>
        <label>Precio (editable)</label>
        <input type="number" id="productPrice" step="0.01">
      </div>

      <div>
        <label>Cantidad</label>
        <input type="number" id="productQty" value="1" min="1">
      </div>
    </div>

    <button class="btn" onclick="addProductToSale()">Agregar</button>
  </section>


  <!-- PRODUCTOS AGREGADOS -->
  <section class="panel space-y-4">

    <h2 class="text-lg font-bold">Productos Agregados</h2>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left border-b" style="border-color:var(--border)">
            <th class="py-2">Producto</th>
            <th>Precio</th>
            <th>Cantidad</th>
            <th>Subtotal</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="itemsTable" class="divide-y" style="divide-color:var(--border)"></tbody>
      </table>
    </div>

    <h2 class="text-xl font-bold text-right">
      Total: $<span id="totalAmount">0.00</span>
    </h2>

    <label>M√©todo de pago</label>
    <select id="paymentMethod">
      <option value="cash">Efectivo</option>
      <option value="card">Tarjeta</option>
      <option value="transfer">Transferencia</option>
    </select>

    <button class="btn w-full mt-3" onclick="submitSale()">Registrar Venta</button>
  </section>

</main>


<script>
/* ==========================================
   Modo oscuro
========================================== */
function toggleTheme(){
  document.documentElement.classList.toggle("dark");
  localStorage.setItem("theme", document.documentElement.classList.contains("dark") ? "dark" : "light");
}
if(localStorage.getItem("theme")==="dark") document.documentElement.classList.add("dark");


/* ==========================================
   Logout
========================================== */
async function logout(){
  await fetch("/api/appointments/logout/", { method:"POST", credentials:"include" });
  location.href = "/api/appointments/login/";
}


/* ==========================================
   Tu c√≥digo JS original empieza aqu√≠
========================================== */

// CSRF
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
          cookie = cookie.trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
          }
      }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

let products = [];
let clients = [];
let saleItems = [];

// Productos
async function fetchProducts(){
  const r = await fetch('/api/products/', { credentials: 'include' });
  const data = await r.json();
  products = Array.isArray(data) ? data : data.results || [];
  const sel = document.getElementById('productSelect');
  sel.innerHTML = '<option value="">-- Selecciona producto --</option>';
  products.forEach(p => {
      sel.innerHTML += `<option value="${p.id}" data-price="${p.price}">${p.name}</option>`;
  });
}

document.getElementById('productSelect').addEventListener('change', function(){
  const price = this.options[this.selectedIndex].getAttribute('data-price') || 0;
  document.getElementById('productPrice').value = price;
});

// Clientes
async function fetchClients(){
  const r = await fetch('/api/users/list/', { credentials: 'include' });
  const data = await r.json();
  clients = Array.isArray(data) ? data : data.results || [];
  const sel = document.getElementById('clientSelect');
  sel.innerHTML = '<option value="">-- Selecciona un cliente --</option>';
  clients.forEach(c => {
      sel.innerHTML += `<option value="${c.id}">${c.username}</option>`;
  });
}

// Agregar producto
function addProductToSale(){
  const id = document.getElementById('productSelect').value;
  const price = parseFloat(document.getElementById('productPrice').value);
  const qty = parseInt(document.getElementById('productQty').value);
  if(!id || price<=0 || qty<=0) return alert("Valores inv√°lidos");
  const product = products.find(p => p.id == id);
  saleItems.push({
    product_id: product.id,
    name: product.name,
    price,
    qty,
    subtotal: price * qty
  });
  renderSaleItems();
}

// Render tabla
function renderSaleItems(){
  const table = document.getElementById('itemsTable');
  table.innerHTML = "";
  let total = 0;
  saleItems.forEach((i, index) => {
    total += i.subtotal;
    table.innerHTML += `
      <tr>
        <td class="py-2">${i.name}</td>
        <td>$${i.price.toFixed(2)}</td>
        <td>${i.qty}</td>
        <td>$${i.subtotal.toFixed(2)}</td>
        <td><button class="btn-danger px-3 py-1 rounded text-white" onclick="removeItem(${index})">X</button></td>
      </tr>`;
  });
  document.getElementById('totalAmount').innerText = total.toFixed(2);
}

function removeItem(index){
  saleItems.splice(index,1);
  renderSaleItems();
}

// Enviar venta
async function submitSale(){
  const clientId = document.getElementById('clientSelect').value;
  const method = document.getElementById('paymentMethod').value;
  if(!clientId) return alert("Selecciona un cliente");
  if(!saleItems.length) return alert("Agrega productos");

  const payload = {
    client: clientId,
    payment_method: method,
    total: parseFloat(document.getElementById('totalAmount').innerText),
    items: saleItems
  };

  const r = await fetch('/api/sales/', {
    method:"POST",
    headers:{ "Content-Type":"application/json", "X-CSRFToken":csrftoken },
    credentials:"include",
    body:JSON.stringify(payload)
  });

  if(r.ok){
    alert("Venta registrada üëç");
    saleItems = [];
    renderSaleItems();
  } else {
    alert("Error al registrar venta");
  }
}

// Init
fetchProducts();
fetchClients();
</script>

</body>
</html>
